version: '3.8'

services:
  # ============================================
  # MQTT to Kafka Bridge
  # Extracts IoT sensor data from MQTT
  # ============================================
  mqtt-bridge:
    build:
      context: .
      dockerfile: Dockerfile.mqtt-bridge
    container_name: mqtt-to-kafka-bridge
    restart: unless-stopped
    networks:
      - smart-city-net
    environment:
      # MQTT Configuration (Simulation VM)
      - MQTT_HOST=10.0.1.134
      - MQTT_PORT=1883
      
      # Kafka Configuration (Pipeline VM)
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    
    healthcheck:
      test: ["CMD", "pgrep", "-f", "mqtt_to_kafka_bridge.py"]
      interval: 30s
      timeout: 10s
      retries: 3
  
  # ============================================
  # RTSP to Kafka Bridge
  # Extracts camera frames from RTSP streams
  # ============================================
  rtsp-bridge:
    build:
      context: .
      dockerfile: Dockerfile.rtsp-bridge
    container_name: rtsp-to-kafka-bridge
    restart: unless-stopped
    networks:
      - smart-city-net
    environment:
      # RTSP Configuration (Simulation VM)
      - RTSP_HOST=10.0.1.134
      - RTSP_PORT=8554
      
      # Kafka Configuration (Pipeline VM)
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      
      # Frame capture settings
      - FRAME_RATE=2
      - FRAME_WIDTH=640
      - FRAME_HEIGHT=480
      - JPEG_QUALITY=70
    
    healthcheck:
      test: ["CMD", "pgrep", "-f", "rtsp_to_kafka_bridge.py"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  smart-city-net:
    external: true
    name: pipline2_smart-city-net